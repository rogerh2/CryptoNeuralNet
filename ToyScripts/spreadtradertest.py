import numpy as np

#test_book was taken at 21:57  on Sep 5 2018
test_book = {'sequence': 4948871033, 'bids': [['226.87', '75.54126341', 11], ['226.85', '20', 1], ['226.8', '1', 1], ['226.72', '20', 1], ['226.63', '6', 1], ['226.43', '6', 1], ['226.41', '6', 1], ['226.26', '1', 1], ['226.16', '6', 1], ['226.14', '19', 2], ['226.05', '43.959', 1], ['226.04', '20.35309838', 2], ['226', '217.69911504', 2], ['225.88', '30', 1], ['225.85', '68.689', 1], ['225.84', '76.5625', 1], ['225.71', '6', 1], ['225.69', '14.24321', 1], ['225.6', '0.0299', 1], ['225.49', '26.6', 1], ['225.41', '10.822522', 1], ['225.39', '300', 1], ['225.3', '16', 1], ['225.29', '40', 1], ['225.21', '20', 1], ['225.15', '12', 1], ['225.09', '23', 1], ['225.06', '0.03417071', 1], ['225', '0.125892', 1], ['224.99', '1', 1], ['224.94', '11.65', 1], ['224.92', '4.666565', 1], ['224.9', '116.911595', 2], ['224.87', '44', 1], ['224.7', '3.41038', 1], ['224.43', '15.740974', 1], ['224.4', '8.50931', 1], ['224.39', '162', 1], ['224.23', '0.074', 1], ['224.21', '10', 1], ['224.2', '10', 1], ['224.08', '0.0758', 1], ['224.01', '2', 1], ['224', '24.44', 2], ['223.97', '0.06385481', 1], ['223.93', '0.074', 1], ['223.87', '10.042316', 1], ['223.86', '8.64175', 1], ['223.83', '2.44475', 1], ['223.8', '18.504556', 1]], 'asks': [['226.88', '2.43232095', 2], ['226.89', '181.16266694', 3], ['226.9', '0.018', 1], ['227.04', '0.09935', 1], ['227.05', '36.2464076', 1], ['227.16', '1.100562', 1], ['227.23', '0.16953535', 1], ['227.24', '6', 1], ['227.25', '58.42', 1], ['227.29', '1', 1], ['227.34', '0.7687008', 1], ['227.45', '66.573', 2], ['227.59', '4.95221237', 2], ['227.66', '58.1', 2], ['227.69', '11.83057', 2], ['227.72', '0.1', 1], ['227.82', '9.51082', 1], ['227.85', '0.1', 1], ['227.86', '19.6', 1], ['227.9', '0.01', 1], ['228', '40.04', 9], ['228.04', '0.7', 1], ['228.25', '15', 1], ['228.28', '0.02', 1], ['228.29', '1.095087', 1], ['228.35', '0.294', 1], ['228.41', '0.29496565', 2], ['228.45', '0.503', 1], ['228.48', '0.05291237', 1], ['228.51', '30', 1], ['228.55', '29.06070408', 1], ['228.61', '0.038', 1], ['228.64', '7.01', 2], ['228.67', '0.01', 1], ['228.7', '0.6999976', 1], ['228.73', '0.03801335', 1], ['228.9', '1', 1], ['228.98', '2.22491116', 2], ['229', '4.072', 6], ['229.2', '21', 1], ['229.3', '12', 1], ['229.31', '0.012', 1], ['229.32', '5', 1], ['229.33', '0.0867145', 1], ['229.36', '1', 1], ['229.43', '1.089638', 1], ['229.44', '66.91250252', 1], ['229.52', '54.81', 1], ['229.53', '254.09773', 1], ['229.76', '0.05444364', 1]]}


def price_loop(prices, spread, trade_sign):
    # Price loop finds trade prices for trades made against the expected move (hence risky_trade_prices is for the
    # dangerous trades
    risky_trade_prices = np.array([])
    conservative_trade_prices = np.array([])

    for i in range(1, len(prices)):
        price = prices[i]
        prior_price = prices[i - 1]
        bid_diff = abs(price - prior_price)
        if (bid_diff > spread) or (i < 5):
            if bid_diff > 0.05:
                risky_price = price + trade_sign*0.01
                risky_trade_prices = np.append(risky_trade_prices, risky_price)

                conservative_price = price + spread + trade_sign*0.01
                conservative_trade_prices = np.append(conservative_trade_prices, conservative_price)

    return risky_trade_prices, conservative_trade_prices

def find_dict_info(dict):
    prices = np.array([round(float(x[0]), 2) for x in dict])
    return prices

def spreadtrade(order_book, spread, direction):
    bids_dict = order_book['bids']
    bid_prices = find_dict_info(bids_dict)

    asks_dict = order_book['asks']
    ask_prices = find_dict_info(asks_dict)

    if direction == 'sell':
        buys, sells = price_loop(bid_prices, spread, 1)

    elif direction == 'buy':
        sells, buys = price_loop(ask_prices, spread, -1)

    return buys, sells

if __name__ == '__main__':
    buy, sell = spreadtrade(test_book, 0.11, 'buy')
    print('buys ' + str(buy))
    print('sells ' + str(sell))